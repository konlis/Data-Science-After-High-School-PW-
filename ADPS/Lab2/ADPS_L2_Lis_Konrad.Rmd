---
title: "ADPS 25L --- Laboratorium 2 (rozwizania)"
author: "Konrad Lis"
output:
  pdf_document:
    latex_engine: xelatex
  html_notebook: default
  html_document: default
---

```{r, echo=FALSE}
pdf.options(encoding='ISOLatin2')
```

# Zadanie 1 (1 pkt)

## Tre zadania

Rozkad Poissona jest czsto u偶ywany do modelowania ruchu ulicznego (o maym nat偶eniu). Plik skrety.txt zawiera liczby pojazd贸w skrcajcych na pewnym skrzy偶owaniu w prawo w przecigu trzystu 3-minutowych przedzia贸w czasu (dane zostay zebrane o r贸偶nych porach dnia).

* Wczytaj dane za pomoc komendy scan('skrety.txt').

* Dopasuj do danych rozkad Poissona, tj. wyestymuj parametr $\lambda$ rozkadu Poissona, zapisz jego warto w sprawozdaniu.

* Sprawd藕 i opisz zgodno rozkadu o wyestymowanym parametrze $\lambda$ z zarejestrowanymi danymi por贸wnujc graficznie empiryczn i teoretyczn funkcj prawdopodobiestwa. U偶yj funkcji table() i\ dpois() analogicznie jak w przykadzie 4 laboratorium 1.

* Metod bootstrapu nieparametrycznego oszacuj odchylenie standardowe estymatora parametru $\lambda$, zapisz jego warto w sprawozdaniu.

## Rozwizanie

* Wczytanie danych

```{r}
skrety = scan('skrety.txt')

```
* Dopasowanie danych

```{r}
lambda = mean(skrety)

```
##### Warto wyestymowanego parametru $\lambda$ wynosi 3.8.



* Zgodno rozkadu z zarejestrowanymi danymi

```{r}
Arg = 0:max(skrety)
Freq = as.numeric(table(factor(skrety, levels = Arg))) / length(skrety)

plot(Freq ~ Arg, type = 'h', col = 'blue', xlab = 'x', ylab = 'f(x)', 
    main = paste0('Funkcja prawdopodobiestwa'))

grid()

lines(dpois(Arg, lambda) ~ Arg, type = 'l', col = 'red',
    xlab = 'x', ylab = 'f(x)')
points(dpois(Arg, lambda) ~ Arg, col = 'red')

legend('topright', c('f.empiryczna', 'f.teoretyczna'),
    col = c('blue', 'red'), lwd = 1)

```

##### Dane empiryczne z s zbli偶one do Rozkadu Poissona



* Bootstrap nieparametryczny

```{r}
K = 10000

boot_lambda = replicate(K, {
    boot_dane = sample(skrety, length(skrety), replace = T)
    c(mean(boot_dane))
})
sd_lambda = sd(boot_lambda)

```

##### Odchylenie standardowe wynosi 0.1311


***

# Zadanie 2 (1 pkt)

## Tre zadania

* Dla wybranej jednej sp贸ki notowanej na GPW oblicz wartoci procentowych zmian najwy偶szych cen w\ dniu (high) w cigu ostatnich dw贸ch lat i wykrel ich histogram.

* Wyestymuj warto redni oraz wariancj procentowych zmian najwy偶szych cen dla wybranej sp贸ki, zapisz te wartoci w sprawozdaniu.

* Na podstawie histogramu i wykresu funkcji gstoci prawdopodobiestwa wyznaczonej dla wyestymowanych parametr贸w (warto rednia i wariancja) zweryfikuj zgrubnie, czy mo偶emy przyj, 偶e procentowe zmiany najwy偶szych cen w dniu maj rozkad normalny.

* Zakadajc, 偶e zmiany najwy偶szych cen w dniu maj rozkad normalny wyznacz 90%, 95% i 99% przedziay ufnoci dla wartoci redniej i wariancji procentowych zmian najwy偶szych cen w dniu dla wybranej sp贸ki. Por贸wnaj wyniki uzyskane dla r贸偶nych przedzia贸w ufnoci.

## Rozwizanie

##### Warto procentowych zmian HIGH na przykadzie sp贸ki COGNOR "COG"

* Wczytanie danych

```{r}
Ticket = 'COG'
webLink = paste0('https://stooq.pl/q/d/l/?s=', Ticket, '&i=d')
fileName = paste0(Ticket, '.csv')
# if(!file.exists(fileName)) {
  download.file(webLink, fileName)
#}
  
df_COG = read.csv('COG.csv')
df_COG$Data = as.Date(df_COG$Data)

```

* Ograniczenie danych do 2 lat

```{r}
df_COG_2lata = df_COG[which(df_COG$Data >= 
    '2023-03-30' & df_COG$Data <= '2025-03-30'),]
```

* Procentowa dzienna najwy偶sza zmienno 

```{r}
df_COG_2lata$Najwy偶szy_zm = with(df_COG_2lata, c(NA, 100*diff(Najwyzszy)/Najwyzszy[-length(Najwyzszy)]))
plot(Najwy偶szy_zm ~ Data, df_COG_2lata, type = 'l', col = 'blue', xlab = 'Data', 
     ylab = 'Procentowa najwy偶sza dzienna zmiana kursu [%]', main = 'Cognor')
grid()
```

* Histogram

```{r}
hist(df_COG_2lata$Najwy偶szy_zm, breaks = 50, prob = T,
  xlab = 'Zmiana kursu najwy偶szego [%] ',
  ylab = 'Czsto wystpowania',
  main = paste('Histogram procentowych zmian kursu', 'COG')  )
grid()
```

* rednia i wariancja najwy偶szych dziennych zmian procentowych

```{r}
Cog_mean = mean(df_COG_2lata$Najwy偶szy_zm, na.rm = T)
Cog_var = var(df_COG_2lata$Najwy偶szy_zm, na.rm = T)
```
##### Warto rednia 0.002
##### Wariancja 6.579

* Funkcja gstoci oraz histogram

```{r}
hist(df_COG_2lata$Najwy偶szy_zm, breaks = 50, prob = T,
    xlab = 'Zmiana kursu najwy偶szego [%] ',
    ylab = 'Czsto wystpowania',
    main = paste('Histogram procentowych zmian kursu', 'COG'))
curve(dnorm(x, 
            mean = Cog_mean, 
            sd = sqrt(Cog_var)),
    add = T, col = 'blue', lwd = 2)
lines(density(na.omit(df_COG_2lata$Najwy偶szy_zm)), col = "red", lwd = 2)
grid()

legend("topright", legend = c("Gsto", "Rozkad normalny"),
    col = c('red', 'blue'))

```

##### Zgrubnie, mo偶emy przyj, 偶e procentowe zmiany najwy偶szych cen w danych dniu maj rozkad zbli偶ony do normalnego.

* Przedziay ufnoci

```{r}
n = length(df_COG_2lata$Najwy偶szy_zm)

```
* Przedzia ufnoci 90%

```{r}
lev_90 = 0.9
S = sqrt(Cog_var)
w = S * qt((1 + lev_90) / 2, df = n - 1) / sqrt(n)
mean_conf_int_90 = c(Cog_mean - w, Cog_mean + w)
a = (1 - lev_90) / 2; b = (1 - lev_90) / 2
var_conf_int_90 = c((n - 1) * S^2 / qchisq(1 - b, df = n - 1),
(n - 1) * S^2 / qchisq(a, df = n - 1))
```
* Przedzia ufnoci 95%

```{r}
lev_95 = 0.95
S = sqrt(Cog_var)
w = S * qt((1 + lev_95) / 2, df = n - 1) / sqrt(n)
mean_conf_int_95 = c(Cog_mean - w, Cog_mean + w)
a = (1 - lev_95) / 2; b = (1 - lev_95) / 2
var_conf_int_95 = c((n - 1) * S^2 / qchisq(1 - b, df = n - 1),
(n - 1) * S^2 / qchisq(a, df = n - 1))
```
* Przedzia ufnoci 99%

```{r}
lev_99 = 0.99
S = sqrt(Cog_var)
w = S * qt((1 + lev_99) / 2, df = n - 1) / sqrt(n)
mean_conf_int_99 = c(Cog_mean - w, Cog_mean + w)
a = (1 - lev_99) / 2; b = (1 - lev_99) / 2
var_conf_int_99 = c((n - 1) * S^2 / qchisq(1 - b, df = n - 1),
(n - 1) * S^2 / qchisq(a, df = n - 1))
```
##### Przedziay ufnoci dla wartoci rednich wynosz:
[0.187, 0192] dla 90%,
[0.223, 0.229] dla 95%,
[0.294, 0.3] dla 99%.

##### Przedziay ufnoci dla wariancji wynosz:
[5.95, 7.33] dla 90%,
[5.83, 7.48] dla 95%,
[5.62, 7.79] dla 99%.

##### Por贸wnanie: Im wy偶szy przedzia ufnoci, tym szerszy zakres wartoci.
***

# Zadanie 3 (1,5 pkt.)

## Tre zadania

Rzucona pinezka upada ostrzem do dou lub do g贸ry. Dowiadczenie to mo偶na opisa rozkadem Bernoulliego z parametrem $p$ bdcym prawdopodobiestwem tego, 偶e pinezka upadnie ostrzem do g贸ry. 

Rozkad parametru $p$ mo偶na opisa rozkadem beta o parametrach $\alpha$ i $\beta$. Warto rednia i wariancja w\ rozkadzie beta zale偶 od parametr贸w rozkadu w nastpujcy spos贸b:
$$ \mathbb{E}X = \frac{\alpha}{\alpha + \beta}, \qquad \mathbb{V}X = \frac{\alpha\beta}{(\alpha + \beta)^2(\alpha + \beta + 1)}, \qquad dominanta = \frac{\alpha - 1}{\alpha + \beta - 2}.$$

* Na podstawie przypuszczanej (a priori) wartoci oczekiwanej parametru $p$ zaproponuj wartoci parametr贸w $\alpha$ i $\beta$ rozkadu a priori parametru $p$. Narysuj rozkad a priori parametru $p$ (wykorzystaj funkcj dbeta()).

* Rzu pinezk 20 razy i zanotuj wyniki kolejnych rzut贸w (1 - pinezka upada ostrzem do g贸ry, 0 - pinezka upada ostrzem do dou). Wyznacz i narysuj rozkad a posteriori parametru $p$ oraz oblicz warto bayesowskiego estymatora $\hat{p}$. W\ rozwa偶anym przypadku rozkad aposteriori parametru $p$ jest r贸wnie偶 rozkadem beta o parametrach:
$$ \alpha_{\textrm{post}} = \alpha_{\textrm{prior}} + \sum_{i=1}^n x_i, \qquad \beta_{\textrm{post}} = \beta_{\textrm{prior}} + n - \sum_{i=1}^n x_i,\qquad x_i\in\{0,1\}.$$

* Rzu pinezk jeszcze 20 razy i zanotuj wyniki. Wyznacz i narysuj rozkad a posteriori oparty na wszystkich 40 rzutach oraz oblicz warto bayesowskiego estymatora $\hat{p}$ w tym przypadku. Por贸wnaj wyniki z wynikami uzyskanymi po pierwszych 20 rzutach.

* Korzystajc ze wzoru na wariancj rozkadu Beta wyznacz i por贸wnaj wariancje rozkad贸w a priori, a\ posteriori po 20 rzutach i a posteriori po 40 rzutach.

## Rozwizanie

* Proponowane wartoci oraz rozkad a priori

```{r}
alpha_prior = 3
beta_prior = 9

curve(dbeta(x, alpha_prior, beta_prior),
    col = 'blue', xlab = 'x', ylab = 'f(x)',
    main = 'Rozkad a priori')
grid()
```

* Rzuty pinezk i rozkad a posteriori

```{r}
rzuty = c(0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0)

suma_1 = sum(rzuty)
n = length(rzuty)

alpha_post = alpha_prior + suma_1
beta_post = beta_prior + n - suma_1

curve(dbeta(x, alpha_post, beta_post),
    col = 'blue', xlab = 'x', ylab = 'f(x)',
    main = 'Rozkad a posteriori dla 20 rzut贸w')
grid()
```
* Warto estymatora Bayesowskiego

```{r}
hat = alpha_post / (alpha_post + beta_post)
```
##### Warto dla estymatora Bayesowskiego wynosi 0.40625.

* Ponowne rzuty pinezk i rozkad a posteriori oparty o wszystkie rzuty

```{r}
rzuty_ponowne = c(1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1)

rzuty_wszystkie = c(rzuty, rzuty_ponowne)
suma_1_wszystkie = sum(rzuty_wszystkie)
n_wszystkie = length(rzuty_wszystkie)

alpha_post_p = alpha_prior + suma_1_wszystkie
beta_post_p = beta_prior + n_wszystkie - suma_1_wszystkie

curve(dbeta(x, alpha_post_p, beta_post_p),
    col = 'blue', xlab = 'x', ylab = 'f(x)',
    main = 'Rozkad a posteriori dla 40 rzut贸w')
grid()
```

* Warto estymatora Bayesowskiego dla wszystkich rzut贸w

```{r}
hat_wszystkie = alpha_post_p / (alpha_post_p + beta_post_p)
```

##### Warto dla estymatora Bayesowskiego wynosi 0.423. 

* Por贸wnanie wariancji

* Rozkad a priori

```{r}
var_prior <- (alpha_prior * beta_prior) / ((alpha_prior + beta_prior)^2 * (alpha_prior + beta_prior + 1))
```

* Rozkad a posteriori po 20 rzutach

```{r}
var_post1 <- (alpha_post * beta_post) / ((alpha_post + beta_post)^2 * (alpha_post + beta_post + 1))
```
* Rozkad a posteriori po 40 szutach

```{r}
var_post2 <- (alpha_post_p * beta_post_p) / ((alpha_post_p + beta_post_p)^2 * (alpha_post_p + beta_post_p + 1))
```

##### Wartoci wariancji rozkad贸w:
A priori: 0.014
A posteriori po 20 rzutach: 0.007
A posteriori po 40 rzutach: 0.004
Z otrzymanych wartoci wynika, 偶e im wiksza liczba rzut贸w, tym wy偶sza dokadno danych.

***

# Zadanie 4 (1,5 pkt.)

## Tre zadania

Plik fotony.txt zawiera odstpy midzy chwilami rejestracji kolejnych foton贸w promieniowania gamma wykonywanymi za pomoc teleskopu kosmicznego Comptona (CGRO) w roku 1991.

* Wczytaj dane za pomoc komendy scan('fotony.txt')

* Metod moment贸w oraz metod najwikszej wiarygodnoci wyznacz estymaty parametr贸w rozkadu gamma odpowiadajce zarejestrowanym danym. Por贸wnaj wyniki uzyskane dla obu metod.

* Narysuj na jednym wykresie histogram odstp贸w oraz funkcje gstoci rozkadu gamma o parametrach wyestymowanych za pomoc obu metod.

* Metod bootstrapu parametrycznego wyznacz dla obu metod (moment贸w oraz najwikszej wiarygodnoci) odchylenia standardowe estymator贸w parametr贸w rozkadu gamma ($\alpha$ i $\beta$) oraz ich przedziay ufnoci na poziomie ufnoci 95%. Por贸wnaj wyniki uzyskane dla obu metod.

## Rozwizanie

* Wczytanie danych

```{r}
odstepy = scan('fotony.txt')
```

* Estymaty parametr贸w

```{r}
mom1 = mean(odstepy)
mom2 = mean(odstepy^2)
alpha_mom = mom1^2/(mom2 - mom1^2)
beta_mom = (mom2 - mom1^2)/mom1
```
##### Wartoci estymator贸w parametr贸w wyznaczone metod moment贸w wynosz: $\alpha$ 1.06 oraz $\beta$ 73.62.

```{r}
require(MASS)
## Loading required package: MASS
est_nw = fitdistr(odstepy, 'gamma', list(shape=1, scale=1), lower=0)
alpha_nw = as.numeric(est_nw$estimate[1])
beta_nw = as.numeric(est_nw$estimate[2])
```
##### Wartoci estymator贸w parametr贸w wyznaczone metod najwikszej wiarygodnoci z wykorzystniem funkcji
fitdistr() wynosz: 继  = 1.0519, 教 = 74.573.

##### Metoda moment贸w jak i najwikszej wairygodnoci daj podobne rezultaty.

* Histogram odstp贸w oraz funkcja gstoci

```{r}
hist(odstepy, probability = TRUE, breaks = 100, xlab = 'Odstpy', ylab = 'Gsto',
    main = paste('Odstpy midzy fotonami'))
curve(dgamma(x, shape = alpha_mom, scale = beta_mom), add = T, col = 'blue', lwd = 1)
curve(dgamma(x, shape = alpha_nw, scale = beta_nw), add = T, col = 'red', lwd = 1)
grid()

legend('topright', c('Metoda moment贸w', 'Metoda najwikszej wiarygodnoci'),
    lty = c(1,1), lwd = c(1.5,1.5), col = c('blue','red'))
```


***